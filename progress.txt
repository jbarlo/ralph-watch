# Ralph Progress Log

## Ticket #1: Init Next.js project with pnpm
- Created Next.js 16 app with App Router, TypeScript, Tailwind, ESLint, pnpm
- Moved project contents from ralph-watch-ui/ subdirectory to workspace root
- Downgraded Tailwind from v4 to v3 due to native binding issues in NixOS environment
- Added tailwind.config.ts, updated postcss.config.mjs and globals.css for Tailwind v3
- Files added: package.json, tsconfig.json, next.config.ts, eslint.config.mjs, postcss.config.mjs, tailwind.config.ts, src/, public/
- Verified: `pnpm build` and `pnpm lint` pass

## Ticket #20: ESLint + Prettier + strict TS + quality check
- Installed prettier, eslint-config-prettier, eslint-plugin-prettier, lodash, @types/lodash
- Created .prettierrc with singleQuote, semi, tabWidth 2
- Updated eslint.config.mjs to extend prettier (flat config format)
- Created .prettierignore to exclude read-only files
- Enabled noUncheckedIndexedAccess in tsconfig.json
- Added scripts: format, lint (updated), typecheck, check
- Ran pnpm format to fix quote styles across codebase
- Files changed: package.json, tsconfig.json, eslint.config.mjs, .prettierrc, .prettierignore
- Verified: `pnpm check` passes (lint + typecheck)

## Ticket #21: Result type utilities for railway-oriented flow
- Created src/lib/result.ts with railway-oriented programming utilities
- Implemented Result<T, E> discriminated union (Ok/Err)
- Added constructor functions: ok(), err()
- Added type guards: isOk(), isErr()
- Added transformations: map(), flatMap(), mapErr()
- Added utilities: unwrapOr(), tryCatch(), tryCatchAsync()
- Files added: src/lib/result.ts
- Verified: `pnpm check` passes

## Ticket #22: Test setup with vitest
- Installed vitest, @testing-library/react, @testing-library/dom, jsdom, @vitejs/plugin-react
- Created vitest.config.ts with jsdom environment and react plugin
- Added scripts: `test` (vitest run), `test:watch` (vitest)
- Updated `check` script to include test: lint + typecheck + test
- Created src/lib/result.test.ts with 16 integration tests for Result utilities
- Files added: vitest.config.ts, src/lib/result.test.ts
- Verified: `pnpm check` passes (all 16 tests pass)

## Ticket #2: Add shadcn/ui and configure
- Initialized shadcn/ui with `pnpm dlx shadcn@latest init` (Neutral color theme)
- Added components: button, card, input, textarea, badge, scroll-area, toast (+ toaster)
- Created components.json config and src/lib/utils.ts (cn utility)
- Created src/hooks/use-toast.ts for toast functionality
- Fixed tailwind.config.ts to use ESM import for tailwindcss-animate
- Fixed eslint warning in use-toast.ts
- Ran pnpm format to fix prettier formatting issues
- Files added: components.json, src/lib/utils.ts, src/components/ui/*.tsx, src/hooks/use-toast.ts
- Files modified: tailwind.config.ts, src/app/globals.css, package.json
- Verified: `pnpm check` passes (lint + typecheck + tests)

## Ticket #3: Clean .gitignore
- Updated .env* pattern to be more specific (.env*.local only)
- Verified all required patterns covered: node_modules, .next, *.tsbuildinfo, .DS_Store
- Confirmed ralph files (tickets.json, progress.txt, CLAUDE.md) remain tracked
- Files changed: .gitignore
- Verified: `pnpm check` passes

## Ticket #4: Zod schemas for ralph files
- Installed zod v4.3.5
- Created src/lib/schemas.ts with loose Zod schemas using passthrough()
- TicketSchema: id (number), title (string), description (optional), status (default 'pending'), priority (optional)
- TicketsFileSchema: { tickets: Ticket[] } with passthrough for unknown fields
- Added CreateTicketSchema and UpdateTicketSchema for API operations
- Created src/lib/schemas.test.ts with 17 integration tests
- Files added: src/lib/schemas.ts, src/lib/schemas.test.ts
- Files modified: package.json
- Verified: `pnpm check` passes (all 33 tests pass)

## Ticket #5: Setup tRPC with file system access
- Installed @trpc/server, @trpc/client, @trpc/react-query, @tanstack/react-query, superjson
- Created src/server/trpc.ts with context (ralphDir from RALPH_DIR env var), superjson transformer
- Created src/server/routers/_app.ts as main router (empty, ready for sub-routers)
- Created src/app/api/trpc/[trpc]/route.ts as fetch handler for GET/POST
- Created src/lib/trpc.ts with createTRPCReact hook for client usage
- Created src/components/providers/TRPCProvider.tsx with React Query + tRPC clients
- Updated src/app/layout.tsx to wrap app with TRPCProvider
- Files added: src/server/trpc.ts, src/server/routers/_app.ts, src/app/api/trpc/[trpc]/route.ts, src/lib/trpc.ts, src/components/providers/TRPCProvider.tsx
- Files modified: src/app/layout.tsx, package.json
- Verified: `pnpm check` passes (all 33 tests pass)

## Ticket #6: tRPC procedures for tickets CRUD
- Created src/server/routers/tickets.ts with full CRUD operations
- list() - reads/parses tickets.json with Zod schema validation
- get(id) - returns single ticket by id, throws if not found
- create(title, description?, priority?) - adds ticket with auto-incremented id
- update(id, data) - partial update, preserves unknown fields
- delete(id) - removes ticket by id
- All operations use Result type for railway-oriented error handling
- Registered tickets router in src/server/routers/_app.ts
- Created src/server/routers/tickets.test.ts with 12 integration tests
- Files added: src/server/routers/tickets.ts, src/server/routers/tickets.test.ts
- Files modified: src/server/routers/_app.ts
- Verified: `pnpm check` passes (all 45 tests pass)

## Ticket #7: tRPC procedure for progress.txt
- Created src/server/routers/progress.ts with read() procedure
- read() returns progress.txt content as string, empty string if file missing
- Uses tryCatchAsync/isErr for railway-oriented error handling
- Registered progress router in src/server/routers/_app.ts
- Created src/server/routers/progress.test.ts with 4 integration tests
- Files added: src/server/routers/progress.ts, src/server/routers/progress.test.ts
- Files modified: src/server/routers/_app.ts
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #8: Ticket list view component
- Created src/components/TicketList.tsx with tRPC integration
- Fetches tickets via trpc.tickets.list.useQuery()
- Displays cards with title, color-coded status badge, and priority
- Status colors: pending (yellow), in_progress (blue), completed (green), failed (red)
- Click to expand/select ticket, shows description when selected
- Supports controlled and uncontrolled selection modes via props
- Empty state when no tickets exist
- Loading and error states handled
- Files added: src/components/TicketList.tsx
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #18: Main page layout
- Redesigned src/app/page.tsx with split view layout
- Desktop: ticket list on left (400px), detail panel on right
- Mobile: tab-based navigation (Tickets/Details tabs)
- Header shows "Ralph Watch" title and project path from RALPH_DIR
- Created config router (src/server/routers/config.ts) with getProjectPath procedure
- Detail panel shows selected ticket info and progress log
- Progress log fetched via tRPC progress.read()
- Responsive design using lg: breakpoint for desktop view
- Files added: src/server/routers/config.ts
- Files modified: src/app/page.tsx, src/server/routers/_app.ts
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #9: Add ticket form
- Created src/components/AddTicketForm.tsx with tRPC integration
- Fields: title (required), description (textarea), priority (number, default 1)
- Submit via trpc.tickets.create.useMutation()
- Clears form on success, invalidates tickets.list query for automatic refresh
- Toast notifications for success and error states
- Client-side validation for required title field
- Disabled button with loading state during submission
- Files added: src/components/AddTicketForm.tsx
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #12: Progress.txt viewer component
- Created src/components/ProgressViewer.tsx with tRPC integration
- Fetches content via trpc.progress.read.useQuery()
- Uses ScrollArea with auto-scroll to bottom when content changes
- Configurable props: autoScroll (default true), height, title, showCard
- Renders as preformatted monospace text
- Loading, error, and empty states handled
- Integrated into main page DetailPanel, replacing inline progress display
- Files added: src/components/ProgressViewer.tsx
- Files modified: src/app/page.tsx
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #10: Edit ticket functionality
- Created src/components/EditTicketForm.tsx with tRPC integration
- Fields: title (required), description (textarea), priority (number), status (select dropdown)
- Status dropdown shows all valid statuses: pending, in_progress, completed, failed
- Submit via trpc.tickets.update.useMutation()
- Toast notifications for success and error states
- Inline editing in detail panel with Edit button toggle
- Cancel button returns to view mode without saving
- Updated Home component to track selectedTicketId instead of full ticket object
- Ticket data now syncs from tRPC query, auto-refreshes after edits
- Files added: src/components/EditTicketForm.tsx
- Files modified: src/app/page.tsx
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #11: Delete ticket functionality
- Added shadcn AlertDialog component for confirmation dialogs
- Created src/components/DeleteTicketButton.tsx with tRPC integration
- Uses AlertDialog for confirmation before deleting
- Calls trpc.tickets.delete.useMutation() on confirm
- Toast notifications for success and error states
- Integrated delete button into DetailPanel next to edit button
- Added onTicketDeleted callback to clear selection and return to ticket list after delete
- Ran pnpm format to fix shadcn generated files formatting
- Files added: src/components/DeleteTicketButton.tsx, src/components/ui/alert-dialog.tsx
- Files modified: src/app/page.tsx, src/components/ui/button.tsx
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #13: SSE endpoint for file watching
- Installed chokidar v5.0.0 for file watching
- Created src/app/api/watch/route.ts SSE endpoint
- Uses singleton FSWatcher to watch tickets.json and progress.txt in RALPH_DIR
- Broadcasts file change events to all connected SSE clients
- Event types: 'connected' (on connect), 'tickets' (tickets.json changed), 'progress' (progress.txt changed), 'error'
- Uses awaitWriteFinish option for stability (100ms threshold)
- Proper cleanup when clients disconnect
- Files added: src/app/api/watch/route.ts
- Files modified: package.json
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #14: Live updates via SSE
- Created src/hooks/use-file-watch.ts with useFileWatch hook
- Connects to /api/watch SSE endpoint via EventSource
- Listens for 'tickets' events and invalidates tickets tRPC queries
- Listens for 'progress' events and invalidates progress tRPC queries
- Automatic reconnection after 3 seconds on disconnect
- State-driven connection: 'connecting' -> 'connected' -> 'disconnected' -> 'connecting'
- Created src/components/ConnectionStatus.tsx with ConnectionStatusIndicator component
- Shows colored dot (green=connected, yellow=connecting, red=disconnected) and status text
- Integrated into Header component in page.tsx
- Files added: src/hooks/use-file-watch.ts, src/components/ConnectionStatus.tsx
- Files modified: src/app/page.tsx
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #15: Status filtering
- Created src/components/TicketFilter.tsx with tab-style filter buttons
- Filter options: all, pending, in_progress, completed, failed
- Created src/hooks/use-ticket-filter.ts for URL params persistence
- Uses Next.js useSearchParams/useRouter to sync filter state with URL (?status=pending etc)
- Updated TicketList to accept statusFilter prop and filter tickets client-side
- Added empty state for when no tickets match the current filter
- Wrapped Home in Suspense boundary (required for useSearchParams)
- Adjusted scroll area height to accommodate filter controls
- Files added: src/components/TicketFilter.tsx, src/hooks/use-ticket-filter.ts
- Files modified: src/components/TicketList.tsx, src/app/page.tsx
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #16: Execute ralph commands from UI
- Created src/server/routers/ralph.ts with runOnce and runAll procedures
- runOnce spawns `ralph-once` (process next ticket) as fire-and-forget
- runAll spawns `ralph` (loop) as fire-and-forget
- Uses spawn with detached:true, stdio:'ignore', and unref() for proper background execution
- Created src/components/RalphControls.tsx with "Run Next Ticket" and "Run All" buttons
- Buttons show loading state and toast notifications on success/error
- Registered ralph router in _app.ts
- Integrated RalphControls into Header next to connection status
- Files added: src/server/routers/ralph.ts, src/components/RalphControls.tsx
- Files modified: src/server/routers/_app.ts, src/app/page.tsx
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #17: Desktop notifications
- Created src/hooks/use-notifications.ts with useNotifications hook
- Requests browser notification permission on page load
- Uses useSyncExternalStore for SSR-safe permission state
- Tracks tab focus state via visibilitychange and focus/blur events
- showNotification() only fires when tab is not focused
- Updated src/hooks/use-file-watch.ts to detect ticket status changes
- Added previousTicketsRef to track ticket states across SSE events
- onTicketStatusChange callback triggers when status changes to 'completed' or 'failed'
- Updated ConnectionStatusIndicator to integrate notifications
- Shows notification permission indicator (pending/blocked) in status bar
- Files added: src/hooks/use-notifications.ts
- Files modified: src/hooks/use-file-watch.ts, src/components/ConnectionStatus.tsx
- Verified: `pnpm check` passes (all 49 tests pass)
## Ticket #19: Multi-project support
- Created src/lib/projects.ts with localStorage utilities for project persistence
- Functions: getProjects, saveProjects, addProject, removeProject, get/setActiveProject
- Per-project filter state persistence: getProjectFilter, setProjectFilter
- Created src/hooks/use-projects.ts with useSyncExternalStore for reactive project list
- Created src/components/ProjectSwitcher.tsx dropdown component
- Uses shadcn Command/Popover components for searchable project selection
- Shows project name and path, add new projects, remove projects
- Added x-ralph-dir header support to tRPC for dynamic project selection
- Updated src/server/trpc.ts createContext to read header and override RALPH_DIR
- Updated tickets, progress, and ralph routers to use ctx.ralphDir
- Updated src/app/api/watch/route.ts to accept dir query parameter
- Per-directory watcher management with cleanup when clients disconnect
- Created src/components/providers/ProjectProvider.tsx for project context
- Created src/components/providers/AppProviders.tsx to combine providers
- Updated src/hooks/use-file-watch.ts to accept ralphDir and reconnect on change
- Updated page.tsx with ProjectSwitcher in header and key-based remounting
- Per-project filter state restored when switching projects
- Fixed test files to use Context type directly instead of createContext()
- Files added: src/lib/projects.ts, src/hooks/use-projects.ts, src/components/ProjectSwitcher.tsx, src/components/providers/ProjectProvider.tsx, src/components/providers/AppProviders.tsx, src/components/ui/command.tsx, src/components/ui/popover.tsx, src/components/ui/select.tsx
- Files modified: src/server/trpc.ts, src/server/routers/tickets.ts, src/server/routers/progress.ts, src/server/routers/ralph.ts, src/app/api/watch/route.ts, src/hooks/use-file-watch.ts, src/components/ConnectionStatus.tsx, src/components/providers/TRPCProvider.tsx, src/app/layout.tsx, src/app/page.tsx, src/server/routers/tickets.test.ts, src/server/routers/progress.test.ts
- Verified: `pnpm check` passes (all 49 tests pass)

## Ticket #23: Fix useSyncExternalStore infinite loop in useProjects
- Bug: getProjectsSnapshot() returned getProjects() which creates new array from JSON.parse each call
- React's useSyncExternalStore saw different reference, triggered re-render, infinite loop
- Fix: Added module-level projectsCache (initialized to EMPTY_PROJECTS)
- Created refreshCache() function that updates projectsCache and calls notifySubscribers()
- getProjectsSnapshot() now returns cached value, initializes cache on first client-side read
- Updated addProject, removeProject, setActiveProject to call refreshCache() instead of notifySubscribers()
- Created src/hooks/use-projects.test.ts with 8 integration tests
- Tests verify: no errors on render, stable references on re-render, add/remove/setActive operations, multiple hook instances
- Files modified: src/hooks/use-projects.ts
- Files added: src/hooks/use-projects.test.ts
- Verified: `pnpm check` passes (all 57 tests pass)

## Ticket #24: Fix hydration mismatch in useNotifications isSupported
- Bug: isSupported computed as `typeof window !== 'undefined' && 'Notification' in window`
- This is false on server but true on client, causing hydration mismatch
- Fix: Used useSyncExternalStore instead of direct computation
- Added getIsSupportedSnapshot() for client (returns `'Notification' in window`)
- Added getIsSupportedServerSnapshot() for server (returns false)
- This ensures server and initial client render match (both false), then React handles the transition
- Note: ticket suggested useState + useEffect but that triggered ESLint set-state-in-effect rule
- Files modified: src/hooks/use-notifications.ts
- Verified: `pnpm check` passes (all 57 tests pass)

## Ticket #25: ProcessRunner interface and types
- Created src/lib/process-runner.ts with types for process lifecycle management
- ProcessHandle: { id: string; pid: number } for identifying spawned processes
- ProcessStatus: discriminated union with 'running' (pid), 'exited' (code), 'not_found' states
- ProcessOutputLine: { stream: 'stdout'|'stderr'; line: string; timestamp: number }
- ProcessStartOptions: { command: string; cwd: string }
- ProcessRunner interface with start, getStatus, kill, onOutput, listRunning methods
- Type guards: isRunning(), isExited(), isNotFound() for status discrimination
- ProcessStatusFactory helper for creating status values
- Created src/lib/process-runner.test.ts with 26 unit tests
- Tests cover: type structure, type guards, factory functions, exhaustive switch matching
- Files added: src/lib/process-runner.ts, src/lib/process-runner.test.ts
- Verified: `pnpm check` passes (all 83 tests pass)

## Ticket #26: ProcessRunner implementation
- Created src/server/services/process-runner.ts implementing ProcessRunner interface
- Uses child_process.spawn with shell: true, stdio: ['ignore', 'pipe', 'pipe']
- Stores processes in Map<string, ProcessRecord> with child, handle, output, callbacks
- ID generation using timestamp + random string (no external deps)
- stdout/stderr capture via readline.createInterface for line-by-line output
- Each output line includes stream type, content, and timestamp
- Exit handling updates exited flag and stores exit code
- onOutput replays existing output to new subscribers, supports unsubscribe
- kill uses SIGTERM with SIGKILL fallback
- listRunning filters for non-exited processes
- Factory function createProcessRunner() for fresh instances
- Singleton getProcessRunner() for server-side use
- Created src/server/services/process-runner.test.ts with 21 integration tests
- Tests spawn real processes (echo, sleep, exit) and verify output capture, status transitions
- Files added: src/server/services/process-runner.ts, src/server/services/process-runner.test.ts
- Verified: `pnpm check` passes (all 104 tests pass)

## Ticket #27: tRPC procedures for ProcessRunner
- Created src/server/routers/process.ts with tRPC router for process management
- start(command) - spawns process via runner.start with ctx.ralphDir as cwd, returns handle or throws
- status(id) - returns ProcessStatus (running/exited/not_found) via runner.getStatus
- kill(id) - terminates process via runner.kill, returns {success: true} or throws
- list() - returns all running ProcessHandle[] via runner.listRunning
- Module-level instance pattern with getRunner()/setRunner() for DI/testing
- Uses singleton getProcessRunner() from services by default
- Registered process router in src/server/routers/_app.ts
- Created src/server/routers/process.test.ts with 16 tests using mock ProcessRunner
- Tests verify: correct args passed, return values, error handling, input validation
- Files added: src/server/routers/process.ts, src/server/routers/process.test.ts
- Files modified: src/server/routers/_app.ts
- Verified: `pnpm check` passes (all 120 tests pass)
